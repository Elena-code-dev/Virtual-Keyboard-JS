const keyboardLayout = [
    [
        {
            code: "Backquote",
            func: false,
            lang: { en: "`", ru: "ё" },
            width: "regular",
        },
        {
            code: "Digit1",
            func: false,
            lang: { en: "1", ru: "1" },
            width: "regular",
        },
        {
            code: "Digit2",
            func: false,
            lang: { en: "2", ru: "2" },
            width: "regular",
        },
        {
            code: "Digit3",
            func: false,
            lang: { en: "3", ru: "3" },
            width: "regular",
        },
        {
            code: "Digit4",
            func: false,
            lang: { en: "4", ru: "4" },
            width: "regular",
        },
        {
            code: "Digit5",
            func: false,
            lang: { en: "5", ru: "5" },
            width: "regular",
        },
        {
            code: "Digit6",
            func: false,
            lang: { en: "6", ru: "6" },
            width: "regular",
        },
        {
            code: "Digit7",
            func: false,
            lang: { en: "7", ru: "7" },
            width: "regular",
        },
        {
            code: "Digit8",
            func: false,
            lang: { en: "8", ru: "8" },
            width: "regular",
        },
        {
            code: "Digit9",
            func: false,
            lang: { en: "9", ru: "9" },
            width: "regular",
        },
        {
            code: "Digit0",
            func: false,
            lang: { en: "0", ru: "0" },
            width: "regular",
        },
        {
            code: "Minus",
            func: false,
            lang: { en: "-", ru: "_" },
            width: "regular",
        },
        {
            code: "Equal",
            func: false,
            lang: { en: "=", ru: "+" },
            width: "regular",
        },
        {
            code: "Backspace",
            func: true,
            lang: { en: "Backspace", ru: "Backspace" },
            width: "black",
        }
    ],
    [
        {
            code: "Tab",
            func: true,
            lang: { en: "Tab", ru: "Tab" },
            width: "black",
        },
        {
            code: "KeyQ",
            func: false,
            lang: { en: "q", ru: "й" },
            width: "regular",
        },
        {
            code: "KeyW",
            func: false,
            lang: { en: "w", ru: "ц" },
            width: "regular",
        },
        {
            code: "KeyE",
            func: false,
            lang: { en: "e", ru: "у" },
            width: "regular",
        },
        {
            code: "KeyR",
            func: false,
            lang: { en: "r", ru: "к" },
            width: "regular",
        },
        {
            code: "KeyT",
            func: false,
            lang: { en: "t", ru: "е" },
            width: "regular",
        },
        {
            code: "KeyY",
            func: false,
            lang: { en: "y", ru: "н" },
            width: "regular",
        },
        {
            code: "KeyU",
            func: false,
            lang: { en: "u", ru: "г" },
            width: "regular",
        },
        {
            code: "KeyI",
            func: false,
            lang: { en: "i", ru: "ш" },
            width: "regular",
        },
        {
            code: "KeyO",
            func: false,
            lang: { en: "o", ru: "щ" },
            width: "regular",
        },
        {
            code: "KeyP",
            func: false,
            lang: { en: "p", ru: "з" },
            width: "regular",
        },
        {
            code: "BracketLeft",
            func: false,
            lang: { en: "[", ru: "х" },
            width: "regular",
        },
        {
            code: "BracketRight",
            func: false,
            lang: { en: "]", ru: "ъ" },
            width: "regular",
        },
        {
            code: "Backslash",
            func: false,
            lang: { en: "\\", ru: "\\" },
            width: "regular",
        },
        {
            code: "Delete",
            func: true,
            lang: { en: "Del", ru: "Del" },
            width: "black",
        }
    ],
    [
        {
            code: "CapsLock",
            func: true,
            lang: { en: "Caps", ru: "Caps" },
            width: "black_2",
        },
        {
            code: "KeyA",
            func: false,
            lang: { en: "a", ru: "ф" },
            width: "regular",
        },
        {
            code: "KeyS",
            func: false,
            lang: { en: "s", ru: "ы" },
            width: "regular",
        },
        {
            code: "KeyD",
            func: false,
            lang: { en: "d", ru: "в" },
            width: "regular",
        },
        {
            code: "KeyF",
            func: false,
            lang: { en: "f", ru: "а" },
            width: "regular",
        },
        {
            code: "KeyG",
            func: false,
            lang: { en: "g", ru: "п" },
            width: "regular",
        },
        {
            code: "KeyH",
            func: false,
            lang: { en: "h", ru: "р" },
            width: "regular",
        },
        {
            code: "KeyJ",
            func: false,
            lang: { en: "j", ru: "о" },
            width: "regular",
        },
        {
            code: "KeyK",
            func: false,
            lang: { en: "k", ru: "л" },
            width: "regular",
        },
        {
            code: "KeyL",
            func: false,
            lang: { en: "l", ru: "д" },
            width: "regular",
        },
        {
            code: "Semicolon",
            func: false,
            lang: { en: ";", ru: "ж" },
            width: "regular",
        },
        {
            code: "Quote",
            func: false,
            lang: { en: "'", ru: "э" },
            width: "regular",
        },
        {
            code: "Enter",
            func: true,
            lang: { en: "Enter", ru: "Enter" },
            width: "black_2",
        }  
    ],
    [
        {
            code: "ShiftLeft",
            func: true,
            lang: { en: "Shift", ru: "Shift" },
            width: "black_2",
        },
        {
            code: "KeyZ",
            func: false,
            lang: { en: "z", ru: "я" },
            width: "regular",
        },
        {
            code: "KeyX",
            func: false,
            lang: { en: "x", ru: "ч" },
            width: "regular",
        },
        {
            code: "KeyC",
            func: false,
            lang: { en: "c", ru: "с" },
            width: "regular",
        },
        {
            code: "KeyV",
            func: false,
            lang: { en: "v", ru: "м" },
            width: "regular",
        },
        {
            code: "KeyB",
            func: false,
            lang: { en: "b", ru: "и" },
            width: "regular",
        },
        {
            code: "KeyN",
            func: false,
            lang: { en: "n", ru: "т" },
            width: "regular",
        },
        {
            code: "KeyM",
            func: false,
            lang: { en: "m", ru: "ь" },
            width: "regular",
        },
        {
            code: "Comma",
            func: false,
            lang: { en: ",", ru: "б" },
            width: "regular",
        },
        {
            code: "Period",
            func: false,
            lang: { en: ".", ru: "ю" },
            width: "regular",
        },
        {
            code: "Slash",
            func: false,
            lang: { en: "/", ru: "." },
            width: "regular",
        },
        {
            code: "ArrowUp",
            func: true,
            lang: { en: "⯅", ru: "⯅" },
            width: "black_arrow_up",
        },
        {
            code: "ShiftRight",
            func: true,
            lang: { en: "Shift", ru: "Shift" },
            width: "black_2",
        } 
    ],
    [
        {
            code: "ControlLeft",
            func: true,
            lang: { en: "Ctrl", ru: "Ctrl" },
            width: "black_2",
        },
        {
            code: "AltLeft",
            func: true,
            lang: { en: "Alt", ru: "Alt" },
            width: "black_2",
        },
        {
            code: "Space",
            func: false,
            lang: { en: " ", ru: " " },
            width: "black_3",
        },
        {
            code: "AltRight",
            func: true,
            lang: { en: "Alt", ru: "Alt" },
            width: "black_2",
        },
        {
            code: "ControlRight",
            func: true,
            lang: { en: "Ctrl", ru: "Ctrl" },
            width: "black_2",
        },
        {
            code: "ArrowLeft",
            func: true,
            lang: { en: "⯇", ru: "⯇" },
            width: "black_arrow_left",
        },
        {
            code: "ArrowDown",
            func: true,
            lang: { en: "⯆", ru: "⯆" },
            width: "black_arrow_up",
        },
        {
            code: "ArrowRight",
            func: true,
            lang: { en: "⯈", ru: "⯈" },
            width: "black_arrow_left",
        }, 
    ],
];
const keyboardKeys = {};
const keyboardFragment = document.createDocumentFragment();

keyboardLayout.forEach((lines) => {
    let line = document.createElement("div");
    line.classList.add("line");

    lines.forEach((key) => {
        keyboardKeys[key.code] = key.lang;
        keyboardKeys[key.code].func = key.func;
        let button = document.createElement("button");
        button.setAttribute("id", key.code);
        button.setAttribute("type", "button");
        button.classList.add("button");
        button.classList.add(`button_${key.width}`);

        button.textContent = key.lang.en;
        line.appendChild(button);
    });
    keyboardFragment.appendChild(line);
});

class Keyboard {
    constructor() {
        this.caps = false;
        this.lang = localStorage.getItem("lang") === "ru" ? "ru" : "en";
    }

    init() {
        this.wrapper = document.createElement("div");
        this.textarea = document.createElement("textarea");
        this.keyboard = document.createElement("div");

        let line = document.createElement("div");
        line.classList.add("line");
       
        this.info = document.createElement("div");
        this.infoText = document.createElement("h2");
        this.infolanguage = document.createElement("h3");

        document.body.classList.add("body");
        this.wrapper.classList.add("wrapper");
        this.textarea.setAttribute("rows", "8");
        this.textarea.autofocus = true;
        this.textarea.classList.add("textarea");
        this.keyboard.classList.add("keyboard");
        this.info.classList.add("info");
        this.infoText.textContent = "Виртуальная клавиатура создана в ОС Windows";
        this.infolanguage.textContent = "Для переключения языка комбинация: Ctrl + Alt";

        this.keyboard.appendChild(keyboardFragment);
        this.showLanguage(this.lang);

        this.wrapper.appendChild(this.textarea);
        this.wrapper.appendChild(this.keyboard);
        this.info.appendChild(this.infoText);
        this.info.appendChild(this.infolanguage);
        document.body.appendChild(this.wrapper);
        document.body.appendChild(this.info);

        this.createListeners();
    }

    createListeners() {
        this.textarea.addEventListener("blur", () => {
            setTimeout(() => {
              this.textarea.focus();
            }, 0);
        });

        document.addEventListener("keydown", (event) => {
            event.stopImmediatePropagation();

            let key = document.getElementById(event.code);
            if (!key) {
                event.preventDefault();
                return;
            }

            if (event.code === "CapsLock" && !event.repeat) {
                event.preventDefault();
                this.caps = !this.caps;
        
                let removeAndAdd = this.caps ? "add" : "remove";
                key.classList[removeAndAdd]("active");
        
                this.switchCaps(event.shiftKey);
            } else {
                key.classList.add("active");
                
                if ((event.ctrlKey || event.metaKey) && event.altKey && !event.repeat) {
                    event.preventDefault();
                    this.lang = this.lang === "ru" ? "en" : "ru";
                    localStorage.setItem("lang", this.lang);
                    this.showLanguage(this.lang, event.shiftKey);
                } else if (!keyboardKeys[event.code].func) {
                    event.preventDefault();
                    this.insertText(key.textContent);
                } else if (event.key === "Shift" && !event.repeat) {
                    event.preventDefault();
                    this.switchCaps(event.shiftKey);
                } else if (event.code === "Tab") {
                    event.preventDefault();
                    this.insertText("\t");
                } else if (event.code === "Enter") {
                    event.preventDefault();
                    this.insertText("\n");
                } else if (event.code === "Backspace") {
                    event.preventDefault();
                    this.pressBackspace();
                } else if (event.code === "Delete") {
                    event.preventDefault();
                    this.pressDelete();
                } else if (event.code === "ArrowUp" && !event.isTrusted) {
                    this.arrowUp();
                } else if (event.code === "ArrowDown" && !event.isTrusted) {
                    this.arrowDown();
                } else if (event.code === "ArrowLeft" && !event.isTrusted) {
                    this.arrowLeft();
                } else if (event.code === "ArrowRight" && !event.isTrusted) {
                    this.arrowRight();
                }
            }
        });
        
        document.addEventListener("keyup", (event) => {
            event.stopImmediatePropagation();
      
            let key = document.getElementById(event.code);
            if (!key) {
              event.preventDefault();
              return;
            }
      
            if (event.code !== "CapsLock") {
              key.classList.remove("active");
              if (event.key === "Shift") {
                event.preventDefault();
                this.switchCaps(event.shiftKey);
              }
            }
        });
      
        this.keyboard.addEventListener("click", (event) => {
            this.textarea.focus();
            const eventKeyDown = new KeyboardEvent("keydown", {
              bubbles: true,
              cancelable: true,
              code: event.target.id,
              view: window,
            });
            document.dispatchEvent(eventKeyDown);
      
            this.textarea.focus();
            const eventKeyUp = new KeyboardEvent("keyup", {
              bubbles: true,
              cancelable: true,
              code: event.target.id,
              view: window,
            });
            document.dispatchEvent(eventKeyUp);
        });
    }
      
        arrowUp() {
          this.textarea.selectionStart = 0;
          this.textarea.selectionEnd = this.textarea.selectionStart;
        }
      
        arrowDown() {
          this.textarea.selectionEnd = this.textarea.textLength;
          this.textarea.selectionStart = this.textarea.selectionEnd;
        }
      
        arrowLeft() {
          this.textarea.selectionStart = Math.max(0, this.textarea.selectionStart - 1);
          this.textarea.selectionEnd = this.textarea.selectionStart;
        }
      
        arrowRight() {
          this.textarea.selectionStart = Math.min(
            this.textarea.textLength,
            this.textarea.selectionEnd + 1,
          );
          this.textarea.selectionEnd = this.textarea.selectionStart;
        }
      
        insertText(chars) {
          const cursorAt = this.textarea.selectionStart;
      
          this.textarea.value =
            this.textarea.value.slice(0, cursorAt) +
            chars +
            this.textarea.value.slice(this.textarea.selectionEnd);
      
          this.textarea.selectionStart = cursorAt + chars.length;
          this.textarea.selectionEnd = this.textarea.selectionStart;
        }
      
        pressBackspace() {
          if (this.textarea.selectionStart !== this.textarea.selectionEnd) {
            this.insertText("");
          } else {
            const cursorAt = Math.max(0, this.textarea.selectionStart - 1);
      
            this.textarea.value =
              this.textarea.value.slice(0, cursorAt) +
              this.textarea.value.slice(this.textarea.selectionEnd);
      
            this.textarea.selectionStart = cursorAt;
            this.textarea.selectionEnd = this.textarea.selectionStart;
          }
        }
      
        pressDelete() {
          if (this.textarea.selectionStart !== this.textarea.selectionEnd) {
            this.insertText("");
          } else {
            const cursorAt = this.textarea.selectionStart;
      
            this.textarea.value =
              this.textarea.value.slice(0, cursorAt) +
              this.textarea.value.slice(cursorAt + 1);
      
            this.textarea.selectionStart = cursorAt;
            this.textarea.selectionEnd = this.textarea.selectionStart;
          }
        }
      
        showLanguage(lang, shift = false) {
          Array.from(this.keyboard.querySelectorAll(".button")).forEach(
            (event) => {
              event.textContent = keyboardKeys[event.id][lang];
            },
          );
      
          this.switchCaps(shift);
        }
      
        switchCaps(shiftKey) {
          const showUpperCase = (this.caps && !shiftKey) || (!this.caps && shiftKey);
          const toCase = showUpperCase ? "toUpperCase" : "toLowerCase";
          Array.from(this.keyboard.querySelectorAll(".button")).forEach(
            (event) => {
              if (!keyboardKeys[event.id].func) {
                if (event.id === "Backquote" && this.lang === "en") {
                  event.textContent = shiftKey ? "~" : "`";
                } else if (event.id === "Minus" && this.lang === "en") {
                  event.textContent = shiftKey ? "_" : "-";
                } else if (event.id === "Equal" && this.lang === "en") {
                  event.textContent = shiftKey ? "+" : "=";
                } else if (event.id === "BracketLeft" && this.lang === "en") {
                  event.textContent = shiftKey ? "{" : "[";
                } else if (event.id === "BracketRight" && this.lang === "en") {
                  event.textContent = shiftKey ? "}" : "]";
                } else if (event.id === "Backslash" && this.lang === "en") {
                  event.textContent = shiftKey ? "|" : "\\";
                } else if (event.id === "Semicolon" && this.lang === "en") {
                  event.textContent = shiftKey ? ":" : ";";
                } else if (event.id === "Quote" && this.lang === "en") {
                  event.textContent = shiftKey ? "\"" : "'";
                } else if (event.id === "Comma" && this.lang === "en") {
                  event.textContent = shiftKey ? "<" : ",";
                } else if (event.id === "Period" && this.lang === "en") {
                  event.textContent = shiftKey ? ">" : ".";
                } else if (event.id === "Slash" && this.lang === "en") {
                  event.textContent = shiftKey ? "?" : "/";
                } else if (event.id === "Slash" && this.lang === "ru") {
                  event.textContent = shiftKey ? "," : ".";
                } else {
                  event.textContent = event.textContent[toCase]();
                }
              }
            },
        );
    }
}

window.addEventListener("DOMContentLoaded", () => {
    const keyboard = new Keyboard();
    keyboard.init();
});